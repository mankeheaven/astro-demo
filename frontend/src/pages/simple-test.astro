---
import Layout from '../layouts/Layout.astro';
---

<Layout title="ç®€åŒ–æµ‹è¯•">
	<div class="container mx-auto p-4">
		<h1 class="text-3xl font-bold mb-6 text-center">ğŸ”§ ç®€åŒ–æµ‹è¯•é¡µé¢</h1>
		
		<div class="mb-6 bg-yellow-100 p-4 rounded-lg">
			<h2 class="text-xl font-bold mb-2">æµ‹è¯•è¯´æ˜</h2>
			<p>è¿™ä¸ªé¡µé¢ç”¨äºæµ‹è¯•ä¿®å¤åçš„è·¨æ¡†æ¶åŠŸèƒ½ï¼Œæ£€æŸ¥æ˜¯å¦è¿˜æœ‰æ— é™å¾ªç¯é—®é¢˜ã€‚</p>
		</div>
		
		<!-- çŠ¶æ€æ˜¾ç¤º -->
		<div id="state-display" class="mb-6 p-4 bg-gray-100 rounded-lg">
			<h3 class="font-bold mb-2">å½“å‰çŠ¶æ€</h3>
			<div id="counter-display" class="text-2xl font-bold mb-2">è®¡æ•°å™¨: 0</div>
			<div id="messages-count" class="text-lg">æ¶ˆæ¯æ•°é‡: 0</div>
		</div>
		
		<!-- ç®€å•æ§åˆ¶ -->
		<div class="flex gap-4 mb-6">
			<button id="increment-btn" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
				+1
			</button>
			<button id="decrement-btn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
				-1
			</button>
			<button id="add-message-btn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
				æ·»åŠ æ¶ˆæ¯
			</button>
		</div>
		
		<!-- æ—¥å¿—è®¡æ•°å™¨ -->
		<div class="bg-black text-green-400 p-4 rounded-lg font-mono text-sm">
			<h3 class="text-white font-bold mb-2">è®¢é˜…ç»Ÿè®¡</h3>
			<div id="subscription-count">è®¢é˜…æ¬¡æ•°: 0</div>
			<div id="update-count">æ›´æ–°æ¬¡æ•°: 0</div>
		</div>
	</div>
</Layout>

<script>
	// ç±»å‹å®šä¹‰
	interface UniversalState {
		sharedCounter: number;
		sharedMessages: Array<{
			id: number;
			text: string;
			framework: string;
			timestamp: string;
		}>;
		currentUser: {
			name: string;
			framework: string;
		};
		theme: string;
		lastUpdated: string;
	}

	let subscriptionCount = 0;
	let updateCount = 0;
	
	// æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
	function updateStats(): void {
		const subscriptionElement = document.getElementById('subscription-count');
		const updateElement = document.getElementById('update-count');
		
		if (subscriptionElement) {
			subscriptionElement.textContent = `è®¢é˜…æ¬¡æ•°: ${subscriptionCount}`;
		}
		if (updateElement) {
			updateElement.textContent = `æ›´æ–°æ¬¡æ•°: ${updateCount}`;
		}
	}
	
	// æ›´æ–°çŠ¶æ€æ˜¾ç¤º
	function updateDisplay(state: UniversalState): void {
		updateCount++;
		
		const counterElement = document.getElementById('counter-display');
		const messagesElement = document.getElementById('messages-count');
		
		if (counterElement) {
			counterElement.textContent = `è®¡æ•°å™¨: ${state.sharedCounter}`;
		}
		if (messagesElement) {
			messagesElement.textContent = `æ¶ˆæ¯æ•°é‡: ${state.sharedMessages.length}`;
		}
		
		updateStats();
	}
	
	// åˆå§‹åŒ–æµ‹è¯•
	async function initSimpleTest(): Promise<void> {
		try {
			console.log('å¼€å§‹ç®€åŒ–æµ‹è¯•...');
			
			// åŠ¨æ€å¯¼å…¥çŠ¶æ€ç®¡ç†å™¨
			const { default: universalStore } = await import('../stores/universalStore.js');
			
			// åˆå§‹æ˜¾ç¤º
			updateDisplay(universalStore.getState());
			
			// è®¢é˜…çŠ¶æ€å˜åŒ–
			subscriptionCount++;
			updateStats();
			
			const unsubscribe = universalStore.subscribe((newState: UniversalState) => {
				console.log('çŠ¶æ€æ›´æ–°å›è°ƒè§¦å‘');
				updateDisplay(newState);
			});
			
			// ç»‘å®šæŒ‰é’®äº‹ä»¶
			const incrementBtn = document.getElementById('increment-btn');
			if (incrementBtn) {
				incrementBtn.addEventListener('click', () => {
					console.log('ç‚¹å‡»å¢åŠ æŒ‰é’®');
					universalStore.incrementCounter();
				});
			}
			
			const decrementBtn = document.getElementById('decrement-btn');
			if (decrementBtn) {
				decrementBtn.addEventListener('click', () => {
					console.log('ç‚¹å‡»å‡å°‘æŒ‰é’®');
					universalStore.decrementCounter();
				});
			}
			
			const addMessageBtn = document.getElementById('add-message-btn');
			if (addMessageBtn) {
				addMessageBtn.addEventListener('click', () => {
					console.log('ç‚¹å‡»æ·»åŠ æ¶ˆæ¯æŒ‰é’®');
					universalStore.addMessage('æµ‹è¯•æ¶ˆæ¯', 'Simple');
				});
			}
			
			console.log('âœ… ç®€åŒ–æµ‹è¯•åˆå§‹åŒ–å®Œæˆ');
			
			// é¡µé¢å¸è½½æ—¶æ¸…ç†
			window.addEventListener('beforeunload', () => {
				unsubscribe();
				console.log('é¡µé¢å¸è½½ï¼Œæ¸…ç†è®¢é˜…');
			});
			
		} catch (error) {
			const errorMessage = error instanceof Error ? error.message : String(error);
			console.error('âŒ ç®€åŒ–æµ‹è¯•åˆå§‹åŒ–å¤±è´¥:', errorMessage);
		}
	}
	
	// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', initSimpleTest);
	} else {
		initSimpleTest();
	}
</script>

<style>
	:global(html.dark) {
		background-color: #1a202c;
		color: #e2e8f0;
	}
</style> 