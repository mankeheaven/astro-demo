---
import Layout from '../layouts/Layout.astro';
---

<Layout title="è·¨æ¡†æ¶åŠŸèƒ½æµ‹è¯•">
	<div class="container mx-auto p-4">
		<h1 class="text-3xl font-bold mb-6 text-center">ğŸ§ª è·¨æ¡†æ¶åŠŸèƒ½æµ‹è¯•</h1>
		
		<div class="mb-6 bg-blue-100 p-4 rounded-lg">
			<h2 class="text-xl font-bold mb-2">æµ‹è¯•è¯´æ˜</h2>
			<p>è¿™ä¸ªé¡µé¢ç”¨äºæµ‹è¯•è·¨æ¡†æ¶çŠ¶æ€å…±äº«åŠŸèƒ½ã€‚è¯·æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹è¯¦ç»†æ—¥å¿—ã€‚</p>
		</div>
		
		<!-- çŠ¶æ€æ˜¾ç¤º -->
		<div id="state-display" class="mb-6 p-4 bg-gray-100 rounded-lg">
			<h3 class="font-bold mb-2">å½“å‰çŠ¶æ€</h3>
			<pre id="state-content">åŠ è½½ä¸­...</pre>
		</div>
		
		<!-- æ§åˆ¶æŒ‰é’® -->
		<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
			<button id="increment-btn" class="bg-green-500 text-white p-3 rounded hover:bg-green-600">
				å¢åŠ è®¡æ•°å™¨
			</button>
			<button id="decrement-btn" class="bg-red-500 text-white p-3 rounded hover:bg-red-600">
				å‡å°‘è®¡æ•°å™¨
			</button>
			<button id="reset-btn" class="bg-gray-500 text-white p-3 rounded hover:bg-gray-600">
				é‡ç½®è®¡æ•°å™¨
			</button>
			<button id="toggle-theme-btn" class="bg-purple-500 text-white p-3 rounded hover:bg-purple-600">
				åˆ‡æ¢ä¸»é¢˜
			</button>
		</div>
		
		<!-- æ¶ˆæ¯æµ‹è¯• -->
		<div class="mb-6">
			<div class="flex gap-2 mb-4">
				<input id="message-input" type="text" placeholder="è¾“å…¥æµ‹è¯•æ¶ˆæ¯" 
				       class="flex-1 p-2 border rounded">
				<button id="send-message-btn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
					å‘é€æ¶ˆæ¯
				</button>
				<button id="clear-messages-btn" class="bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600">
					æ¸…é™¤æ¶ˆæ¯
				</button>
			</div>
		</div>
		
		<!-- æ—¥å¿—æ˜¾ç¤º -->
		<div class="bg-black text-green-400 p-4 rounded-lg font-mono text-sm">
			<h3 class="text-white font-bold mb-2">å®æ—¶æ—¥å¿—</h3>
			<div id="log-container" class="max-h-60 overflow-y-auto">
				<div>ç­‰å¾…æ—¥å¿—...</div>
			</div>
		</div>
	</div>
</Layout>

<script>
	// ç±»å‹å®šä¹‰
	interface UniversalState {
		sharedCounter: number;
		sharedMessages: Array<{
			id: number;
			text: string;
			framework: string;
			timestamp: string;
		}>;
		currentUser: {
			name: string;
			framework: string;
		};
		theme: string;
		lastUpdated: string;
	}

	// æ—¥å¿—è®°å½•å‡½æ•°
	function addLog(message: string): void {
		const logContainer = document.getElementById('log-container');
		if (!logContainer) return;
		
		const timestamp = new Date().toLocaleTimeString();
		const logEntry = document.createElement('div');
		logEntry.textContent = `[${timestamp}] ${message}`;
		logContainer.appendChild(logEntry);
		logContainer.scrollTop = logContainer.scrollHeight;
	}
	
	// æ›´æ–°çŠ¶æ€æ˜¾ç¤º
	function updateStateDisplay(state: UniversalState): void {
		const stateContent = document.getElementById('state-content');
		if (stateContent) {
			stateContent.textContent = JSON.stringify(state, null, 2);
		}
	}
	
	// åˆå§‹åŒ–æµ‹è¯•
	async function initTest(): Promise<void> {
		try {
			addLog('å¼€å§‹åˆå§‹åŒ–è·¨æ¡†æ¶çŠ¶æ€ç®¡ç†å™¨...');
			
			// åŠ¨æ€å¯¼å…¥çŠ¶æ€ç®¡ç†å™¨
			const { default: universalStore } = await import('../stores/universalStore.js');
			
			addLog('çŠ¶æ€ç®¡ç†å™¨å¯¼å…¥æˆåŠŸ');
			
			// è·å–åˆå§‹çŠ¶æ€
			const initialState = universalStore.getState();
			updateStateDisplay(initialState);
			addLog(`åˆå§‹çŠ¶æ€: ${JSON.stringify(initialState)}`);
			
			// è®¢é˜…çŠ¶æ€å˜åŒ–
			const unsubscribe = universalStore.subscribe((newState: UniversalState, oldState?: UniversalState) => {
				addLog('çŠ¶æ€å˜åŒ–é€šçŸ¥æ”¶åˆ°');
				updateStateDisplay(newState);
				
				if (oldState) {
					addLog(`çŠ¶æ€å˜åŒ–: ${JSON.stringify({
						counter: { old: oldState.sharedCounter, new: newState.sharedCounter },
						messages: { old: oldState.sharedMessages.length, new: newState.sharedMessages.length },
						theme: { old: oldState.theme, new: newState.theme }
					})}`);
				}
			});
			
			// ç»‘å®šæŒ‰é’®äº‹ä»¶
			const incrementBtn = document.getElementById('increment-btn');
			if (incrementBtn) {
				incrementBtn.addEventListener('click', () => {
					addLog('ç‚¹å‡»å¢åŠ æŒ‰é’®');
					universalStore.incrementCounter();
				});
			}
			
			const decrementBtn = document.getElementById('decrement-btn');
			if (decrementBtn) {
				decrementBtn.addEventListener('click', () => {
					addLog('ç‚¹å‡»å‡å°‘æŒ‰é’®');
					universalStore.decrementCounter();
				});
			}
			
			const resetBtn = document.getElementById('reset-btn');
			if (resetBtn) {
				resetBtn.addEventListener('click', () => {
					addLog('ç‚¹å‡»é‡ç½®æŒ‰é’®');
					universalStore.resetCounter();
				});
			}
			
			const toggleThemeBtn = document.getElementById('toggle-theme-btn');
			if (toggleThemeBtn) {
				toggleThemeBtn.addEventListener('click', () => {
					addLog('ç‚¹å‡»ä¸»é¢˜åˆ‡æ¢æŒ‰é’®');
					universalStore.toggleTheme();
				});
			}
			
			const sendMessageBtn = document.getElementById('send-message-btn');
			if (sendMessageBtn) {
				sendMessageBtn.addEventListener('click', () => {
					const input = document.getElementById('message-input') as HTMLInputElement;
					if (input) {
						const message = input.value.trim();
						if (message) {
							addLog(`å‘é€æ¶ˆæ¯: ${message}`);
							universalStore.addMessage(message, 'Test');
							input.value = '';
						}
					}
				});
			}
			
			const clearMessagesBtn = document.getElementById('clear-messages-btn');
			if (clearMessagesBtn) {
				clearMessagesBtn.addEventListener('click', () => {
					addLog('æ¸…é™¤æ‰€æœ‰æ¶ˆæ¯');
					universalStore.clearMessages();
				});
			}
			
			// å›è½¦å‘é€æ¶ˆæ¯
			const messageInput = document.getElementById('message-input') as HTMLInputElement;
			if (messageInput) {
				messageInput.addEventListener('keypress', (e) => {
					if (e.key === 'Enter') {
						sendMessageBtn?.click();
					}
				});
			}
			
			// è®¾ç½®æµ‹è¯•ç”¨æˆ·
			universalStore.setUser('æµ‹è¯•ç”¨æˆ·', 'Test');
			
			addLog('âœ… æµ‹è¯•é¡µé¢åˆå§‹åŒ–å®Œæˆ');
			
			// é¡µé¢å¸è½½æ—¶æ¸…ç†
			window.addEventListener('beforeunload', () => {
				unsubscribe();
				addLog('é¡µé¢å¸è½½ï¼Œæ¸…ç†è®¢é˜…');
			});
			
		} catch (error) {
			const errorMessage = error instanceof Error ? error.message : String(error);
			addLog(`âŒ åˆå§‹åŒ–å¤±è´¥: ${errorMessage}`);
			console.error('æµ‹è¯•é¡µé¢åˆå§‹åŒ–å¤±è´¥:', error);
		}
	}
	
	// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', initTest);
	} else {
		initTest();
	}
</script>

<style>
	:global(html.dark) {
		background-color: #1a202c;
		color: #e2e8f0;
	}
</style> 